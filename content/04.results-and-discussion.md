## Results

### Torsion energy barriers are sensitive to the chemical environment, which can be influenced by remote substituents
In most forcefields, torsions are defined by the quartet of atom types involved in the dihedral [CITE].
However, the quartet of atom types do not always capture the relevant chemistry, especially when the effects
are non local i.e., atoms contributing to hyperconjugation, delocalization or other non classical effects,
are not part of the quartet involved in the torsion [@doi:10.1186/s13321-019-0371-6]. Figure {@fig:biphenyls}A illustrates
such a case with a series of biphenyls in different protonation states. While the MM torsion profiles
are all the same (Fig 2B), the QC torsion profiles are different for each protonation state (Fig 2C). 
The torsion energy barrier increases relative to the neutral state for the cation, anion and zwitterion, in that order.
The profile changes qualitatively as well. For the neutral molecule, the lowest energy conformer
is slighlty out of plane, at $150^{\circ}$ and $120^{\circ}$.  For the zwitterion, the lowest energy 
conformer is at $180^{\circ}$. In the neutral molecule, the slightly out of plane conformer is preferred to accommodate
the hydrogens. However, the central bond in the zwitterion is part of the larger conjugated system between the two aromatic
rings (Fig 2D) so the planar conformer is preferred to enable conjugation. This trend poses several problems to 
automatic forcefield parametrization. Most forcefields consider the central bond
in the zwitterion rotatable while the QC scan clearly shows that is it not. This illustrates one
of the fundamental limits of atom types in classical forcefields. At what point in this series should
a new atom type be introduced? The Open Force Field Initiative's effort on automating data driven direct
chemical perception [@doi:10.1021/acs.jctc.8b00640 ;@doi:10.1021/acs.jctc.8b00821; @doi:10.26434/chemrxiv.8304578.v1]
addresses this problem by using SMIRKS patterns to assign parameters, and providing a framework to sample over 
SMIRKS space in a data driven way. In addition, this example illustrates why fragmenting molecules
appropriately for QC torsion scans requires human expertise and is difficult to automate. 
In this case, a small change three bonds away from the torsion central bond changed the bond from 
a rotatable bond to a non-rotatable conjugated bond. When fragmenting molecules we need to avoid
destroying a bond's chemical environment by naively removing an important remote substituent.

![**Illustration of the sensitivity of torsion profiles to remote chemical changes in a molecule**
**[A]** Biphenyl protonation states and tautomers with increasing Wiberg bond order for the central bond.
**[B]** The resonance structure of the biphenyl zwitterion shows that the central bond is conjugated. The Wiberg bond order
and torsion scan for this bond (see **A** and **C**) are reflective of a conjugated bond. **[C]** Relative QC energy as a function of
torsion angle of the central bond. The colors of the QC scan corresponds to the highlighted bonds in **A**. **[D]** Torsion barrier heights vs
WBOs. The color of the data points correspond to the highlighted bonds in **A**. The QC torsion barrier height is linear WBO.](images/figure_3.svg){#fig:biphenyls}

### The Wiberg Bond Order quantifies the electronic population overlap between two atoms and captures bond conjugation
The Wiberg bond order (WBO) is a bond property that is calculated using orthonormalized atomic orbitals that are used
as basis sets in semi-empirical QC methods[CITE]. Wiberg originally formulated it for the CNDO basis set [CITE] but it can be 
easily extended to other semi-empirical QC methods such as AM1 [@doi:10.1021/ja00299a024] and PM3 [CITE]. The WBO is a measure
of electron density between two atoms in a bond and is given by the quadratic sum of the density matrix elements over 
occupied atomic orbitals on atoms A and B

\begin{equation} W_{AB} = \sum_{\mu\in A}\sum_{\nu\in B} P^2_{\mu\nu} \end{equation}

To check how well $W_{AB}$ recapitulates the multiplicity of bonds, we calculated $W_{AB}$ from AM1 calculations 
for all bonds in FDA approved molecules in DrugBank [@doi:10.1093/nar/gkx1037]. The distribution [fig 3] corresponds
closely with bond multiplicity. The plateau at 0.8 correspond to bonds involving S and P since these are weaker and longer bonds. The plateau at 1.0
corresponds to C-H and C-C bonds, the plataea at 1.5 corresponds to bonds in aromatic rings, the plateau at 2.0 corresponds
to double bonds, and finally the triple bonds form the last plateau. The density between 1.0-1.4 correspond to the 
conjugated bonds not inside rings.

The Wiberg bond order assumes atomic orbitals (AOs) are orthonormal. In ab initio calculations, however, AOs are not
orthogonal but the WBO can be calculated via Löwdin normalization [@doi:10.1063/1.1747632; @doi:10/bdfk5f] which is how it is calculated in Psi4.

We calculated the WBO from AM1 calculations for the biphenyl series as shown in figure 2A. The increase in the WBO corresponds
to increasing conjugation and torsion energy barrier height of the bond. When the torsion energy barrier heights are plotted against
the WBO [fig 2E], the relationship is linear with an $R^2$ of [hold].

### The WBO is an inexpensive surrogate for the chemical environment around a bond
Since the WBO can be calculated from a cheap AM1 calculation, is indicative of a bond's conjugation, and is correlated with torsion energy
barrier height, it is an attractive measure to use as a surrogate when automating fragmentation or interpolating torsion force constants. However,
WBOs are conformational dependent [@doi:10.1039/c6ra17055b] so we investigated this dependence to understand if WBOs
will be a robust descriptor. In addition, we also investigated the generality of the torsion energy barrier and WBO linear relationship.
In this section we will first discuss our findings and solution to the conformational dependency and then discuss how general the linear relationship is.

#### Conformation dependent variance of WBOs are higher for conjugated bonds
Since WBOs are a function of the electronic density, which is conformational dependent, WBOs change with conformation. However, not all bonds' WBOs
change the same way with conformation. We found that WBOs for conjugated bonds are multimodal with respect to conformation and that bonds
involved in conjugated systems have WBOs that are correlated with each other.

To investigate how WBOs change with conformation, we used Omega [@doi:10.1021/ci100031x] to generate
conformers for a set of kinase inhibitors [Supplementary figure 1] and calculated the Lowdin-Wiberg bond order for each conformation from an
hf3c [@doi:10.1002/jcc.23317] geometry optimized calculation using Psi4 [@doi:10.1021/acs.jctc.7b00174].Omega is a knowledge-based
conformer generator that uses a modified version of MMFF94s [@doi:10/brxdg7] to score conformations. It has been shown to accurately reproduce experimentally
observed crystallography conformers in the Platinum benchmark dataset [@doi:10.1021/acs.jcim.7b00505]. Figure 4 illustrates
the results for Gefitinib [Figure 4A], a representative molecule. Figure 4B shows the distribution of WBOs for all rotatable bonds
color coded with the colors used to highlight the bonds in Gefitinib [Fig 4A]. Single carbon-carbon bonds, and carbon-nitrogen bonds
formed by atoms numbered 10 - 13 are freely rotating. This is reflected by the tight distribution of WBOs around 1.00 for those bonds.
The bonds involving the ether oxygens and aromatic rings (formed by atoms numbered 1-3, 8-10, 19, 23-24) exhibit higher variance
and multimodality. It is interesting to note the difference in the WBOs for the conjugated bonds formed by the nitrogen between
the quinazoline and chloro fluro phenyl (bonds formed by atoms numbered 19, 23 and 23, 24). Both of these bonds are conjugated
with their neighboring ring systems, however, While the distribution of WBOs for bond 19-23
(the purple distribution) is clearly bimodal, the WBO distribution for bond 23-24 has lower variance. This is in agreement
with the resonance structures shown in figure 4D. The resonance strictures that have the double bond on the bond closer to
the quinazoline (bond 19-23) are more stable because the negative charge is on a nitrogen. When the double bond is on the neighboring
23-24 bond, the negative charge is on an aromatic carbon which is less stable. The results are similar for other kinase inhibitors
tested shown in supplementary figure 1. In addition, when we inspected the conformations associated with each mode in the purple distribution [figure 4B]
we found that conformations with lower WBOs on bond 19-23 had that bond out of plane while the conformations in the higher mode of the distribution
had the bond in plane which allows conjugation. We found similar results from WBOs calculated form QC torsion scans. Fig 2D shows the Lowdin-Wiberg
bond order for each point in the QC torsion scans of the biphenyl zwitterion. The WBOs are perfectly anti-correlated with the torsion potential energy
which is in line with chemical intuition. Conjugation stabilizes conformations and leads to more electronic population overlap in bonds [CITE].
At higher energy conformers, the aromatic rings are out of plan and cannot conjugate. Therefore the WBO is lower for those conformers. At lower energy
conformations, the rings are in plane and can conjugate so the WBO is higher.

#### Bonds in conjugated systems have highly correlated conformation-dependent WBOs
We found that certain bond orders are strongly correlated or anticorrelated with each other, indicating strong electronic coupling.
Figure 4C shows the Pearson correlation coefficient for each bond WBO distribution against all other bond WBO distributions.
There is a clear structure in this correlation plot. The square formed by bonds from atoms 24-29 shows that the alternating
bonds in the aromatic ring are strongly anticorrelated with each other. While the ring formed by atoms 13-18 also exhibit this
trend, the absolute Pearson correlation coefficients are not as high given that it is not an aromatic ring. The bonds involved
in the ethers (atoms 1-3 adn 8-10) are strongly correlated with each other and also correlated to the quinazoline, albeit not as strongly.
And the bonds between the chloro fluoro phenyl and quinazoline follow the same trend as their WBO distribution and resonance structures.
The bond closer to the quinazoline (bond 23-19) has WBO distribution correlated with the quinazoline while the bond closer to the
chloro fluoro phenyl (bond 23-24) is not as strongly coupled with the quinazoline or phenyl ring. The results are similar
for other kinase inhibitors tested as shown in supplementary figure 1

#### ELF10 provides a useful way to capture informative conformation-independent WBOs
As we have shown, the WBO is conformation dependent and this dependency can also be highly informative of the electronic coupling
in a system. Figure 5 shows the distribution of standard deviations of WBO distribution with respect to conformation in blue.
Most of the standard deviations fall below 0.02, which is encouragingly small. However, it can become computationally expensive to calculate the WBO for all conformations. If we want to
use WBOs as a surrogate to determine if our fragment is representative of the parent molecule in a reproducible way,
we need a way to capture informative conformation-independent WBOs. Electronically Least-interacting Functional groups (ELF) conformation selection implemented in quacpac
[CITE] resolves the issue of sensitivity of molecular mechanics electrostatic energies from QM derived charges.
[Leave to Christopher Bayly to describe]{.banner .lightyellow}
This method can also be applied to deriving WBOs that are insensitive to conformers. To test how well ELF10 WBOs correspond to expected
WBOs, we calculated ELF10 WBOs for the kinase inhibitor set shown in supplementary figure 1. Figure 3A shows the distribution of all ELF WBO. To
gain insight how the ELF10 WBOs corresponds to bond multiplicity, we separated the distributions by element. Figure 3B shows the distributions
of carbon-carbon bonds. The blue distribution shows the carbon-carbon bonds not in rings. There are peaks at one, two and three
which correspond to single, double and triple bonds. Single bonds are the most abundant followed by double and then triple. The blue
distribution shows carbon-carbon bonds in rings. There is a peak as 1.0 and 1.5 which corresponds to single and aromatic rings.
Longer, weaker bonds involving Sulfur and Phosphorous  [Fig 3C] both have peaks at ~0.6. Oxygen has a peak at 1.0 and 1.8 which corresponds
to single and double bonds. For the rest of this section we will be focusing on the robustness and generalizability of ELF10 WBOs.

#### WBOs are a robust signal to how remote substituent changes alter a bond's torsion barrier height
To investigate how resonance and electronic effects from remote substituents change the torsion energy of a bond,
we took inspiration from the Hammett equation [@doi:10.1021/ja01280a022] of reactions involving benzoic acid derivatives.
The Hammett equation relates meta and para benzoic acid substituents to the acid's ionization equilibrium constants

\begin{equation} log \frac{K}{K_0} = \sigma\rho \end{equation}

Where $\sigma$ is a substituent constant and $\rho$ is a reaction constant. It aims to isolate the resonance and inductive effects
of substituents from the sterics effects of a reaction. Here, we generated a combinatorial set of meta and para subsituted phenyls
and pyridine {@fig:subsituted_phenyls}A with 25 functional groups that cover a wide range of electron donating and withdrawing groups.
We then calculated the ELF10 WBO for the bond attaching the functional
group to the aromatic ring for all functional groups which resulted in 128 (25*3+3) data points for each functional group. This allowed us to isolate the effect on a bond's WBO from remote chemical environment changes,
defined as a change more than two bonds away, from other effects such as sterics and conformations. The resulting distributions are in {@fig:subsituted_phenyls}B.
It is interesting to note that the trend of decreasing WBOs for more electron
donating groups are anti correlates with increasing Hammett substituent constants. In {fig@subsituted_phenyls}C and D, the AM1 ELF10 WBO of the bond
between the functional group and benzoic acid is plotted against their Hammett para and meta substituent constants. Functional groups
that are more electron donating will have more electron density on the bond attaching the functional group to the benzoic acid. The resonance and/or inductive effect
destabilize the benzoate, increases its pKa, which corresponds to lower substituent constants.

![**Change in AM1 ELF10 WBOs correlates with barrier heights in torsion profiles**
**[A]** Systems and functional groups used in the subsituted phenyl set. The functional groups were chosen to span a large range
of electron donating and withdrawing groups.
**[B]** AM1 ELF10 WBO distributions for the bond between the phenyl ring and $X_1$ in different chemical environments  **[C]** Hammett sigma para
parameters vs AM1 ELF10 WBOs of  $X_1$ para to carboxylic acid **[D]** Hammett sigma meta parameters vs AM1 ELF10 WBOs of $X_1$ meta to
carboxyilic acid **[E]** Selected QC torsion scan barrier heights vs ELF10 AM1 WBOs](images/figure_6.svg){#fig:subsituted_phenyls}

|functional group | slope | $r^2$ | P value | standard error |
|---|---|---|---|---|
| $N(Me)_2$ | 116.916250 | 0.880571 | 0.000019 | 14.352479 |
| $NHMe$ | 134.517241 |  0.896103 |  0.000033 | 16.194060 |
| $NH_2$ |   64.266814 |  0.577819 |  0.017438 | 20.763035 |
| $NHEt$ |  119.513117 |  0.836392 |  0.000552 | 19.978559 |
| $NH(C_3H_7)$ |  163.763962 |  0.871119 |  0.000236 | 23.808080 |
| $OH$ |  154.824936 |  0.729133 |  0.003393 | 35.666975 |
| $OMe$ |  185.309951 |  0.800852 |  0.006494 | 41.326214 |
| $OEt$ |  119.662499 |  0.479470 |  0.038706 | 47.124984 |
| $NHCON(Me)_2$ |  159.312781 |  0.579507 |  0.010533 | 47.979491 |
| $NHCONHMe$ |  127.645256 |  0.434585 |  0.053430 | 55.030363 |
| $NHCONH_2$ |  238.119990 |  0.734429 |  0.003158 | 54.120536 |
| $NHCOEt$ |  205.802258 |  0.692740 |  0.005374 | 51.804680 |
| $NHCOMe$ |  144.320372 |  0.457787 |  0.065376 | 64.121783 |
| $OCONH_2$ |  172.716947 |  0.508785 |  0.111518 | 84.854215 |
| $COOH$ |  267.218639 |  0.739937 |  0.061417 | 91.463658 |
| $COOEt$ |  149.012778 |  0.581298 |  0.077956 | 63.233457 |
| $NO_2$ |  302.072242 |  0.909174 |  0.003192 | 47.737899 |

Table: slope and associated statistics for torsion barrier height vs WBO for selected functional groups {#tbl:stats}

To investigate how these long range effects observed in the WBOs capture changes in the bonds' torsion potential energy, we ran representative QC torsion
scans for 17 of the functional groups (SI figure 4). We did not run QC torsion scans for functional groups that either did not have a torsion such
as halogens, were congested such as trimethyl amonium and functional groups where the WBOs did not change by more than 0.01 for different functional
groups at the meta or para position such as methyl. We chose the representative molecules for the 17 functional groups by sorting them
by their WBO and selecting molecules with minimum WBO difference of 0.02. All of the resulting QC torsion scans are shown in supplementary
figure 4. We show a representative series of torsion scan for the nitro functional group in figure {@fig:sub_phenyl_qc_scan}A. The torsion energy barrier height
increase with increasing ELF10 WBO of the bond. In addition, {@fig:sub_phenyl_qc_scan}B  shows that the Wiberg-Lowdin bond orders are anti-correlated with
the QC torsion scan which is the same result we saw for the initial bipheynl set discussed in the previous section. We also found that the linear
relationshipt between WBOs and torsion energy barrier height
shown in {@fig:biphenyls}D  generalizes to all functional groups tested in this set {@fig:subsituted_phenyls}E. Table @tbl:stats lists the slopes and
associated statistics for the fitted lines.

![**Löwdin-Wiberg bond orders are anti correlated with QC torsion scans**
**[A]** QC torsions for methylamino in series of different chemical environment. Barrier heights increase with increasing ELF10 AM1 WBOs
**[B]** Löwdin-Wiberg bond orders calculated at each point in the QC torsion scan using the same level of theory. The bond orders are
anti correlated with QC torsion scans **[C]** QC scans for urea in a series of different chemical environment. Both profiles and
energy barriers change with ELF10 AM1 WBOs **[E]** Löwdin-Wiberg bond orders are not perfectly anti correlated to QC scans](images/figure_7.svg){#fig:sub_phenyl_qc_scan}

For most functional groups, the change in WBOs correspond to changes in torsion barrier heights. [supplementary figure 4].
However, for some functional groups, the change in WBO does not fully capture the differences in torsion scans because not only do the torsion energy
barrier heights increase, but the profile changes considerably as shown in {@fig:sub_phenyl_qc_scan}C for urea. Interestingly, the Löwdin-Wiberg
bond order scans do have the same profiles {@fig:sub_phenyl_qc_scan}D.

When we compare the standard deviations of WBO distributions with respect to conformation versus with respect to changes in chemical space [Figure 5 red distribution],
we find that the changes in ELF10 WBO for remote chemical environment changes are bigger than the changes in WBO that arise from change in conformation.
This allows us to use the difference in ELF10 WBO of parent and fragment as a good surrogate to the level of disruption of the chemical environment.

### A simple fragmentation scheme can use the WBO to preserve the chemical environment around a torsion
The WBO is a robust indicator of changes in torsion energy barrier heights for related torsions. Therefore, if a fragment's
WBO changes too much from its parent WBO at the same bond, the fragmentation is probably inadequate. Using this concept,
we extended the fragment-and-cap scheme proposed by [CITE Pfizer paper] by considering resonance via WBOs. The scheme, illustrated
in figure 8 is as follows:

1. Find rotatable bond. For this step we use the SMARTS pattern [hold for SMARTS pattern]
2. Build out one bond in each direction
3. If the next atom is part of a ring or part of a functional group listed in figure 8B, keep the ring and functional group
4. Keep meta substitutents to the rotatable bond of interest because it is involved in the sterics of the torsion
4. Cap with hydrogen and recalculate WBO
5. If the fragment's WBO differs by more than a user defined threshold, continue grow out one bond at a time until the
fragment's WBO is within the threshold of the parent WBO.

### Fragmentation schemes can be assessed by their ability to preserve the chemical environment while minimizing fragment size
This fragmentation scheme improves upon Pfizers scheme, however, it leaves some parameters up to the user. In order to asses various
thresholds and different fragmentation schemes in general, we generated a diverse set of FDA-approved drug molecules that can be
a useful validation set. The goal of this set was to find molecules that are challenging to fragment. In other words, molecules
that have bonds that are sensitive to remote substituent changes. To find these molecules, we first filtered DrugBank (version 5.1.3 downloaded
on 2019-06-06) with the following criteria:

1. FDA approved small molecules
2. Largest ring size has less than 14 heavy atoms
3. Smallest ring size has at least 3 heavy atoms
4. Molecule must have at least one aromatic ring
5. Molecule has only one connnected component

This left us with 730 small molecules [Supplementary figure 3]. Charged molecules exacerbates remote substituent sensitivity and many
molecules are in charged states at physiological pH. To ensure that our dataset is representative of drugs at physiological pH, we used
the OpenEye `EnumerateReasonableTautomers` to generate tautomers that are highly populated at pH ~7.4. This tautomer enumeration
extended the set to 1234 small molecules [Supplementary figure 3B]
We then generated all possible fragments of these molecules by using a combinatorial fragmentation scheme. In this scheme, every rotatable
bond is fragmented and then all possible connected fragments are generated where the smallest fragment has 4 heavy atoms and the largest
fragment is the parent molecule. This scheme generated ~300,000 fragments.
For each fragment, Omega was used to generate conformers and the AM1 WBO was calculated for every bond in every conformer. This resulted
in a distribution of WBOs for all bonds in all fragments as shown in figure 9A.

#### Scoring how well fragments preserve chemical environments using WBO distributions
Each fragment needs to be assigned a score of how well is preserves its parent chemical environment. To score each fragment, we compare
the conformer dependent WBO for a bond in a fragment context against the conformer-dependent distribution of WBO for the same bond in the parent molecule
context. To compare these distributions, we compute the maximum mean discrepancy [CITE] with a squared kernel for the fragment distribution
to the parent as follows:

\begin{equation} MMD = \sqrt{(E[X]-E[Y])^2 + (E[X^2] - E[Y^2])^2} \end{equation}

where $X$ is the parent WBO distribution and $Y$ is the fragment WBO distribution. Including the squared mean incorporates the variance
of the distribution. It is important incorporate changes in variance given how the variance of the WBO distributions change for different
chemical environments. The final validation set was chosen by finding the fragments that have bonds with the top 50 scoring MMD scores.
The 50 molecules are shown in figure 10. The sensitive bonds that are high scoring are highlighted.

#### Good fragmentation schemes minimize both chemical environment disruption and fragment size
The goal of our fragmentation scheme is to find fragments that have a WBO distribution of the bond of interest closest the the parent
while minimizing the size of the fragment. We can use the distance score calculated with MMD as an indicator of how far the fragment's
WBO distribution is. When we plot the fragment size against this score, the points that fall on the Pareto front [CITE] are the ones where the
distance score is the best for for a given fragment size or vice versa. Figure 9B shows an illustrative example of this. The aim of
any fragmentation scheme is to find fragments on the Pareto front that minimize both the WBO distance and fragment size. In other words,
they should be on the lower left corner of the plot.
We want to find the parameters for our fragmentation scheme that maximizes the number of fragments that end up in that lower left corner.
To do that, we fragmented the 50 molecules in the validation set using different disruption thresholds. For every molecule, we found the distance
score of their fragments' WBO distribution and their size. We then plotted all fragments from the validation set for different thresholds [figure 11]
When the threshold is low, the fragmenation scheme will generate fragments which have very good scores, but many of them will be too big
for computational efficient QC torsion scan. On the other hand, when the disruption threshold is too low, the scheme generates
fragments that are small but the distance score is too big. For the molecules we tested, a threshold of 0.01 leads to the most fragments
on the Pareto front as shown in table 1. This threshold is similar to what we found when we looked at the distribution of standard deviations for
WBO distributions with respect to conformations [figure 5 blue distribution]. Most of them fall under 0.02. Both of these data points
leads us to recommend a distruption threshold of 0.01 for our fragmentation scheme. While the current scheme does not provide a perfect solution, the
plot in figure 11B shows a few fragments outside of the lower left region, it preforms considerably better than other schemes such as the Pfizer
scheme [Figure 11D] and Bemis Murko [Figure 11E]. The Bemis Murko scheme was not designed for this application so it is not surprising how poorly it
preforms.